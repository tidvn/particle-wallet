"use client";
import{a as $,b as j,c as J,d as Z}from"./chunk-IY67DJC7.js";import{a as W}from"./chunk-YWGBV3CL.js";import{a as H}from"./chunk-4SMRMVPX.js";import"./chunk-QNAXMJIS.js";import{a as q}from"./chunk-AMOVWUCP.js";import{h as N}from"./chunk-PZJW4BGW.js";import"./chunk-O6HTNRMG.js";import{H as Q,J as X,K as Y,L as R,M as ss,a as G,m as M,o as K,v as T}from"./chunk-ZHONLBSB.js";import"./chunk-L535NPP3.js";import{RecordType as O}from"@particle-network/analytics";import{SolanaEnhancedMethod as Cs,SolanaRpcMethod as r,analyticsRecord as x,isNeedRestoreWallet as As,particleAuth as t,syncUserInfo as es}from"@particle-network/auth-core";import{Button as ns,Modal as ws,Tabs as _s}from"antd";import D from"bs58";import e,{useEffect as L,useMemo as as,useState as f}from"react";import Ss from"react-copy-to-clipboard";import{useTranslation as ks}from"react-i18next";var Ts="ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL",Ns={async findAssociatedTokenAddress(C,i){let{TOKEN_PROGRAM_ID:d}=await import("@solana/spl-token"),{PublicKey:p}=await import("@solana/web3.js");return p.findProgramAddressSync([new p(C).toBuffer(),d.toBuffer(),new p(i).toBuffer()],new p(Ts))[0]}},E=Ns;function Ps(C){let{method:i,param:d,chainId:p}=C,{t:o}=ks(),A=X(),{setPaymentVerify:os,userInfo:m,setPaymentPassword:is}=Y(),{events:rs}=ss(),{modalOptions:w}=R(),{authCoreModal:ts}=Q(),{errorHandle:ds}=W(),[U,_]=f(!1),z=H(),[c,ls]=f(),[S,cs]=f(),[k,ms]=f(),[gs,u]=f(""),[ps,h]=f(""),{hasSetPaymentPassword:P,showSetPaymentPasswordOrConfirm:vs}=j(),g=as(()=>({id:p||t.solana.chainId,name:"Solana"}),[]),fs=as(()=>{let n=t.solana.selectedAddress;return T(n)},[]);L(()=>{es().catch(n=>{}),As()&&A("account/master-password/verify")},[A]);let us=()=>{es().then(()=>{F()}).catch(n=>{var s;_(!1),z.error((s=n.message)!=null?s:"Sign Error")})},B=(n,s)=>{rs.emit("signResponse",{result:n,error:s})};async function V(n,s){if(!s)return[];let a=await Promise.all(s.map(n));return s.filter((v,l)=>a[l])}let F=async()=>{var n,s;!i||(x({record_type:O.PAGE_SIGN_CONFIRM_BUTTON_CLICK}),(n=m==null?void 0:m.security_account)!=null&&n.has_set_payment_password?os({visible:!0,onVerifyCompleted:I}):i===r.signAndSendTransaction||i===r.signTransaction||i===r.signAllTransactions||((s=w==null?void 0:w.promptSettingConfig)==null?void 0:s.promptPaymentPasswordSettingWhenSign)===3?vs(I):I())},I=async()=>{var s;if(!i)return;_(!0);let n;try{if(i===r.signMessage)n=await t.solana.signMessage(d);else if(i===r.signAndSendTransaction)n=await t.solana.signAndSendTransaction(d,g.id);else if(i===r.signTransaction)n=await t.solana.signTransaction(d,g.id);else if(i===r.signAllTransactions)n=await t.solana.signAllTransactions(d,g.id);else throw new Error("Unknown method");x({record_type:O.PAGE_SIGN_CONFIRM_BUTTON_CLICK_SUCCESS})}catch(a){x({record_type:O.PAGE_SIGN_CONFIRM_BUTTON_CLICK_FAILURE}),(a==null?void 0:a.error_code)===50103&&!((s=m==null?void 0:m.security_account)!=null&&s.has_set_payment_password)?us():(a==null?void 0:a.message)==="Local Key not found"||(a==null?void 0:a.message)==="Master password decryption error"?A("account/master-password/verify"):ds(a)}finally{_(!1)}n&&B(n)};L(()=>{if(i===r.signMessage)u(o("sign.signature_message")),h(o("sign.signature_title"));else if(i===r.signAndSendTransaction){u(o("sign.send_transaction")),h(o("sign.approve_and").format(M(g)));let n=d.serialize({requireAllSignatures:!1,verifySignatures:!1});y([D.encode(n)])}else if(i===r.signTransaction){u(o("sign.sign_transaction")),h(o("sign.sign_but"));let n=d.serialize({requireAllSignatures:!1,verifySignatures:!1});y([D.encode(n)])}else if(i===r.signAllTransactions){u(o("sign.sign_transaction")),h(o("sign.sign_but"));let n=d.map(s=>D.encode(s.serialize({requireAllSignatures:!1,verifySignatures:!1})));y(n)}else throw new Error("Unknown method")},[d]),L(()=>{t.solana.connect()},[]);let y=n=>{t.solana.request({chainId:g.id,method:Cs.enhancedDeserializeTransaction,params:n}).then(s=>{var a,v;ls(s),V(async l=>{let b=await E.findAssociatedTokenAddress(t.solana.selectedAddress,l.mint);return l.associatedTokenAddress===b.toBase58()},(a=s==null?void 0:s.estimatedChanges)==null?void 0:a.nfts).then(l=>{cs(l)}),V(async l=>{let b=await E.findAssociatedTokenAddress(t.solana.selectedAddress,l.mint);return l.associatedTokenAddress===b.toBase58()},(v=s==null?void 0:s.estimatedChanges)==null?void 0:v.tokens).then(l=>{ms(l)})}).catch(s=>{var a;ws.error({title:(a=s.message)!=null?a:"Deserialize Transaction Error",okCancel:!0,cancelText:o("common.cancel"),okText:o("common.retry"),wrapClassName:"auth-core-modal-error",getContainer:()=>ts.rootBody,onOk:()=>{y(n)}})})},hs=()=>{let s=new TextDecoder().decode(d);return e.createElement("div",{className:"sign-message"},e.createElement("div",{className:"message"+(P?"":" no-password-tip")},e.createElement("div",{className:"pre-wrap personal-message"},s)))},ys=()=>{var n;return e.createElement(_s,{defaultActiveKey:"1",items:[{label:o("sign.details"),key:"1",children:e.createElement(e.Fragment,null,e.createElement("div",{className:"balance-change"},e.createElement("div",{className:"title"},o("sign.estimated_balance_change")),e.createElement("div",{className:"change-body"},(n=c==null?void 0:c.estimatedChanges)==null?void 0:n.sols.filter(s=>{var a,v;return s.address===((v=(a=t)==null?void 0:a.solana)==null?void 0:v.selectedAddress)}).map((s,a)=>e.createElement("div",{className:"change-title",key:`sol-change-${a}`},"SOL",e.createElement("div",{className:"change-val",style:s.lamportsChange<0?{color:"#ea4335"}:{}},s.lamportsChange<0?"":"+",N(s.lamportsChange,9)))),S==null?void 0:S.map((s,a)=>e.createElement("div",{className:"change-title",key:`nft-change-${a}`},s.name?s.name:"Unknown NFT",e.createElement("div",{className:"change-val",style:s.amountChange<0?{color:"#ea4335"}:{}},s.amountChange<0?"":"+",s.amountChange))),k==null?void 0:k.map((s,a)=>e.createElement("div",{className:"change-title",key:`token-change-${a}`},s.name?s.name:"Unknown Token",e.createElement("div",{className:"change-val",style:s.amountChange<0?{color:"#ea4335"}:{}},s.amountChange<0?"":"+",N(s.amountChange,s.decimals)))))),e.createElement("div",{className:"net-fee solana"},e.createElement("div",{className:"title"},o("sign.network_fee"),c&&e.createElement("div",{className:"fee-val"},N(c.estimatedLamportsFee,9)," SOL"))))},{label:o("sign.data"),key:"2",children:e.createElement("div",null,c==null?void 0:c.instructions.map((s,a)=>e.createElement("div",{className:"inner-instruction",key:`instruction-${a}`},e.createElement("div",{className:"inner-content"},e.createElement("div",{className:"content-item"},e.createElement("div",{className:"item"},e.createElement("div",{className:"item-0"},"#",a+1," - ",o(`program.${s.type}`)),e.createElement("div",{className:"item-1 mt10"},o("sign.program_id"),e.createElement("span",null,T(s.programId))),e.createElement("div",{className:"item-1 mt15"},o("sign.data"),e.createElement("span",null,T(s.data)))))))))}]})};return e.createElement("div",{className:"info-sign"},e.createElement("style",null,J),!P&&e.createElement("div",{className:"has-payment-password"},e.createElement("div",{className:"has-payment-password-icon"}),e.createElement("div",{className:"has-payment-password-tip"},o("account.waring_tip1")),e.createElement("div",{className:"has-payment-password-set",onClick:is},o("account.set"))),e.createElement("div",{className:"scroll-part"+(P?"":" no-password-tip")},e.createElement(Z,{userInfo:m,transactionInfo:c}),e.createElement("div",{className:"info-request"},gs),e.createElement("div",{className:"info-title"},e.createElement("img",{src:K(g),alt:""}),M(g)),e.createElement(Ss,{text:t.solana.selectedAddress,onCopy:()=>z.success(o("new.copied_to"))},e.createElement("div",{className:"info-address"},fs,e.createElement("div",{className:"copy-icon"},e.createElement($,null)))),e.createElement("div",{className:"info-des"},ps),e.createElement("div",{className:"apart-line"}),i===r.signMessage&&hs(),i!==r.signMessage&&ys()),e.createElement("div",{className:"btn-box"},e.createElement("div",null,e.createElement(ns,{className:"btn-cancel",onClick:()=>{U||B(void 0,G.userRejectedRequest())}},o("common.cancel")),e.createElement(ns,{className:"btn-approve",onClick:F,loading:U},o("common.confirm"))),e.createElement(q,null)))}var Zs=Ps;export{Zs as default};
